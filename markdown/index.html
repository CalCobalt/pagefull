<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Markdown ç¼–è¾‘å™¨</title>

<!-- Styles from external libs (æ”¾åˆ°åŒç›®å½•) -->
<link rel="stylesheet" href="highlight.css">
<link rel="stylesheet" href="katex.min.css">

<style>
/* ====== é¢œè‰²ç³»ç»Ÿï¼ˆæ”¯æŒäº®/æš—æ¨¡å¼ + è·Ÿéšç³»ç»Ÿï¼‰ ====== */
/* ====== ä¼˜é›…çš„ä¸»é¢˜åˆ‡æ¢ï¼šå…¨å±€æ·¡å…¥åŠ¨ç”» ====== */
html {
  transition: background-color 0.35s ease,
              color 0.35s ease,
              filter 0.35s ease;
}

/* æ•´ä½“æ·¡å…¥æ•ˆæœï¼ˆå¯è°ƒèŠ‚ï¼‰ */
body {
  transition: background-color 0.35s ease,
              color 0.35s ease;
}

/* æ‰€æœ‰é¢æ¿ã€å·¥å…·æ ã€ç¼–è¾‘åŒºå…±åŒæ·¡å˜ */
.panel, .toolbar, #editorPanel, #previewPanel, #editor, .mobile-tab {
  transition:
    background-color 0.35s ease,
    border-color 0.35s ease,
    color 0.35s ease,
    box-shadow 0.35s ease;
}

/* æš—è‰²æ¨¡å¼å¾®å¾®æ¨¡ç³Šï¼Œè®©åˆ‡æ¢åƒç›¸æœºè‡ªåŠ¨æ›å…‰ */
[data-theme="dark"] body {
  filter: brightness(94%) saturate(110%);
}

[data-theme="light"] body {
  filter: brightness(100%) saturate(100%);
}

:root{
  /* æµ…è‰²æ¨¡å¼ */
  --bg:#f6f7fb;
  --panel:#ffffff;
  --text:#0f1724;
  --muted:#6b7280;
  --border:#d0d4dd;
  --editor-bg:#ffffff;
  --toolbar-bg:#ffffff;
  --btn-hover:rgba(0,0,0,0.07);
  --code-bg:#f3f4f6;
  --code-text:#111;
}

/* æ·±è‰²æ¨¡å¼å˜é‡ */
[data-theme="dark"]{
  --bg:#071122;
  --panel:#0d1a33;
  --text:#e6eef8;
  --muted:#9aa7b7;
  --border:#32425a;
  --editor-bg:#0d1a33;
  --toolbar-bg:#081226;
  --btn-hover:rgba(255,255,255,0.08);
  --code-bg:#111b2d;
  --code-text:#e6eef8;
}

/* ====== å¸ƒå±€ç»“æ„ ====== */
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:Inter,"PingFang SC","Microsoft Yahei",sans-serif;
  background:var(--bg);
  color:var(--text);
}
.app{max-width:1200px;margin:18px auto;padding:12px;}
.header{display:flex;align-items:center;gap:12px;}
.brand{font-weight:800;font-size:18px;}
.header .right{
  margin-left:auto;
  display:flex;
  gap:8px;
  align-items:center;
}

/* ====== å·¥å…·æ  ====== */
.toolbar{
  display:flex;gap:6px;flex-wrap:wrap;
  background:var(--toolbar-bg);
  padding:8px;
  border-radius:10px;
  box-shadow:0 6px 20px rgba(0,0,0,0.08);
  margin-top:12px;
  border:1px solid var(--border);
}
.toolbar button{
  border:0;
  background:transparent;
  padding:8px 10px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
  color:var(--text);
}
.toolbar button:hover{
  background:var(--btn-hover);
}

/* ====== ä¸‰åˆ—å¸ƒå±€ ====== */
.main{
  display:grid;
  grid-template-columns:260px 1fr 1fr;
  gap:12px;
  margin-top:12px;
}
.panel{
  background:var(--panel);
  border-radius:10px;
  box-shadow:0 8px 30px rgba(0,0,0,0.1);
  padding:12px;
  min-height:64vh;
  overflow:auto;
  border:1px solid var(--border);
}

/* ====== ç¼–è¾‘åŒº ====== */
#editor{
  width:100%;
  height: calc(100vh - 160px); /* è‡ªåŠ¨å¡«æ»¡å±å¹• */
  min-height: 60vh;            /* é˜²æ­¢è¿‡å° */
  max-height: 100vh;
  border:0;
  outline:none;
  padding:12px;
  font-family:ui-monospace,monospace;
  font-size:14px;
  resize:vertical;
  background:var(--editor-bg);
  color:var(--text);
}


/* ====== é¢„è§ˆåŒºæ ·å¼ ====== */
#preview{
  padding:12px;
}
#preview pre{
  background:var(--code-bg);
  color:var(--code-text);
  padding:10px 12px;
  border-radius:8px;
  overflow:auto;
}
#preview code{
  background:var(--code-bg);
  color:var(--code-text);
  padding:3px 5px;
  border-radius:5px;
}

/* ====== TOC ====== */
.toc h3{margin:6px 0;}
.toc a{
  color:var(--text);
  text-decoration:none;
}
.toc a:hover{
  color:var(--accent);
}

/* ====== æ‰‹æœºæ¨¡å¼ ====== */
.mobile-tabs{display:none;}

@media(max-width:1000px){
  .main{grid-template-columns:1fr;}
  #previewPanel{display:none;}
  .mobile-tabs{display:flex;gap:8px;margin-top:8px;}
}

.mobile-tab{
  flex:1;
  padding:10px;
  text-align:center;
  border-radius:8px;
  background:var(--panel);
  color:var(--text);
  border:1px solid var(--border);
  cursor:pointer;
}
.mobile-tab.active{
  background:var(--bg);
  box-shadow:0 6px 18px rgba(0,0,0,0.2);
}
.theme-3way {
  width: 125px;
  height: 40px;
  position: relative;
  margin: 0 8px;
}

.theme-3way .track {
  background: var(--toolbar-bg);
  border: 1px solid var(--border);
  border-radius: 40px;
  height: 100%;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-around;
  position: relative;
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(0,0,0,0.08);
  transition: background 0.3s, border-color 0.3s;
}

.theme-3way .opt {
  position: relative;
  z-index: 2;
  font-size: 15px;
  opacity: 0.7;
  transition: opacity 0.25s, transform 0.25s;
  user-select: none;
}

.theme-3way .opt.active {
  opacity: 1;
  transform: scale(1.2);
}

.theme-3way .thumb {
  position: absolute;
  z-index: 1;
  height: 33px;
  width: 33px;
  border-radius: 50%;
  background: var(--panel);
  top: 3px;
  left: calc(50% - 16px);
  transition: left 0.35s cubic-bezier(0.25,0.8,0.25,1), background 0.3s;
  box-shadow: 0 0 12px rgba(255,200,50,0.5);
}

[data-theme="dark"] .theme-3way .thumb {
  box-shadow: 0 0 12px rgba(100,150,255,0.6);
}

/* PC ç«¯æ˜¾ç¤º / æ‰‹æœºç«¯éšè— */
.pc-only { display: block; }
.mobile-only { display: none; }

@media(max-width:1000px){
  .pc-only { display: none; }
  .mobile-only {
    display: flex;
    gap: 6px;
  }
}

/* ====== PC ç«¯æ»‘å— ====== */
.theme-3way {
  width: 125px;
  height: 40px;
  position: relative;
  margin: 0 8px;
}

.theme-3way .track {
  background: var(--toolbar-bg);
  border: 1px solid var(--border);
  border-radius: 40px;
  height: 100%;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-around;
  position: relative;
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(0,0,0,0.08);
  transition: background 0.3s, border-color 0.3s;
}

.theme-3way .opt {
  position: relative;
  z-index: 2;
  font-size: 15px;
  opacity: 0.7;
  transition: opacity 0.25s, transform 0.25s;
  user-select: none;
}

.theme-3way .opt.active {
  opacity: 1;
  transform: scale(1.2);
}

.theme-3way .thumb {
  position: absolute;
  z-index: 1;
  height: 33px;
  width: 33px;
  border-radius: 50%;
  background: var(--panel);
  top: 3px;
  left: calc(50% - 16px);
  transition: left 0.35s cubic-bezier(0.25,0.8,0.25,1), background 0.3s;
  box-shadow: 0 0 12px rgba(255,200,50,0.5);
}

[data-theme="dark"] .theme-3way .thumb {
  box-shadow: 0 0 12px rgba(100,150,255,0.6);
}


/* æ‰‹æœºç«¯å•æŒ‰é’® */
.theme-mobile-btn {
  background: var(--toolbar-bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 12px;
  font-size: 18px;
  cursor: pointer;
  transition: background .25s, transform .2s;
  color: var(--text);
}

.theme-mobile-btn:active {
  transform: scale(0.9);
}


@media(max-width:1000px){
  .pc-only { display: none; }
  .mobile-only { display: inline-flex; }
}

</style>

</head>
<body>

<div class="app" id="app">
  <div class="header">
    <div class="brand">Markdown ç¼–è¾‘å™¨</div>
    <div class="note">ç¦»çº¿</div>
    <div class="right">
      <div id="status" class="note">å·²åŠ è½½ Â· è‡ªåŠ¨ä¿å­˜</div>
      <div class="theme-3way pc-only">
        <div class="track">
          <div class="thumb"></div>
          <span class="opt opt-auto" data-value="auto">ğŸ–¥</span>
          <span class="opt opt-light" data-value="light">â˜€ï¸</span>
          <span class="opt opt-dark" data-value="dark">ğŸŒ™</span>
        </div>
      </div>

      <!-- ç§»åŠ¨ç«¯ç‰ˆï¼ˆä¸‰æŒ‰é’®ï¼‰ -->
<!-- ç§»åŠ¨ç«¯å•æŒ‰é’®ï¼ˆç‚¹å‡»è½®æ¢ auto â†’ light â†’ darkï¼‰ -->
      <button class="theme-mobile-btn mobile-only" id="themeMobileBtn">ğŸ–¥</button>

    </div>
  </div>

  <div class="toolbar" role="toolbar" aria-label="ç¼–è¾‘å·¥å…·æ ">
    <div class="controls">
      <button data-action="bold" title="åŠ ç²—ï¼ˆCtrl/Cmd+Bï¼‰"><strong>B</strong></button>
      <button data-action="italic" title="æ–œä½“ï¼ˆCtrl/Cmd+Iï¼‰"><em>I</em></button>
      <button data-action="h1" title="H1">H1</button>
      <button data-action="h2" title="H2">H2</button>
      <button data-action="code" title="ä»£ç å—">{ }</button>
      <button data-action="ul" title="æ— åºåˆ—è¡¨">â€¢ åˆ—è¡¨</button>
      <button data-action="ol" title="æœ‰åºåˆ—è¡¨">1.</button>
      <button id="btnLink" title="æ’å…¥é“¾æ¥">ğŸ”—</button>
      <button id="btnImage" title="æ’å…¥å›¾ç‰‡">ğŸ–¼ï¸</button>
      <input id="fileImage" type="file" accept="image/*" style="display:none">
    </div>

    <div style="flex:1"></div>

    <div class="controls">
      <button id="btnOpen">æ‰“å¼€</button>
      <input id="fileOpen" type="file" accept=".md,text/markdown,text/plain" style="display:none">
      <button id="btnSaveMd">å¯¼å‡º MD</button>
      <button id="btnSaveHtml">å¯¼å‡º HTML</button>
      <button id="btnToggleToc">TOC</button>
    </div>
  </div>

  <div class="mobile-tabs" id="mobileTabs">
    <div id="tabEdit" class="mobile-tab active">ç¼–è¾‘</div>
    <div id="tabPreview" class="mobile-tab">é¢„è§ˆ</div>
  </div>

  <div class="main">
    <!-- TOC / ä¾§æ  -->
    <div class="panel toc" id="tocPanel">
      <h3>ç›®å½•ï¼ˆTOCï¼‰ <button id="tocCollapseBtn" title="æŠ˜å /å±•å¼€">â–¾</button></h3>
      <div id="tocContent">ï¼ˆæ— æ ‡é¢˜ï¼‰</div>
      <hr>
      <div style="font-size:13px;color:var(--muted);margin-top:8px">
        å¿«æ·ï¼š<span class="kbd">Ctrl/Cmd+B</span> <span class="kbd">Ctrl/Cmd+S</span>
      </div>
    </div>

    <!-- ç¼–è¾‘åŒº -->
    <div class="panel" id="editorPanel">
      <textarea id="editor" spellcheck="false" aria-label="Markdown ç¼–è¾‘åŒº"></textarea>
    </div>

    <!-- é¢„è§ˆåŒº -->
    <div class="panel" id="previewPanel">
      <div id="preview" class="preview" aria-live="polite"></div>
    </div>
  </div>
</div>

<!-- Libraries (æ”¾åˆ°åŒç›®å½•) -->
<script src="markdown-it.min.js"></script>
<script src="markdown-it-emoji.min.js"></script>
<script src="markdown-it-footnote.min.js"></script>
<script src="markdown-it-sub.min.js"></script>
<script src="markdown-it-sup.min.js"></script>
<script src="markdown-it-mark.min.js"></script>
<script src="markdown-it-container.min.js"></script>
<script src="markdown-it-task-lists.min.js"></script>

<script src="highlight.min.js"></script>
<script src="katex.min.js"></script>
<script src="mermaid.min.js"></script>

<script>
/* ===============================
   åˆå§‹åŒ– markdown-itï¼ˆå®Œæ•´ç‰ˆ + æ’ä»¶ï¼‰
   =============================== */
const themeMobileBtn = document.getElementById("themeMobileBtn");
let userTheme = loadUserTheme();
const md = window.markdownit({
  html:true,
  linkify:true,
  typographer:true,
  highlight: function(code, lang){
    try{
      if(lang && hljs.getLanguage(lang)) return hljs.highlight(code, {language:lang}).value;
      return hljs.highlightAuto(code).value;
    }catch(e){
      return md.utils.escapeHtml(code);
    }
  }
})
.use(window.markdownitEmoji)
.use(window.markdownitSub)
.use(window.markdownitSup)
.use(window.markdownitMark)
.use(window.markdownitContainer, 'info')
.use(window.markdownitFootnote)
.use(window.markdownitTaskLists, {label:true});

/* ===============================
   å¸¸é‡ä¸å…ƒç´ 
   =============================== */
const editor = document.getElementById('editor');
const preview = document.getElementById('preview');
const status = document.getElementById('status');
const STORAGE_KEY = 'md-editor:content:v2';
const THEME_KEY = 'md-editor:theme';
const TOC_COLLAPSED = 'md-editor:toc:collapsed';

/* ===============================
   åˆå§‹å†…å®¹ï¼ˆç¤ºä¾‹ï¼‰
   =============================== */
const DEFAULT = `# æ¬¢è¿ä½¿ç”¨

è¿™æ˜¯ä¸€ä¸ª**ç¦»çº¿ã€å•æ–‡ä»¶**çš„ Markdown ç¼–è¾‘å™¨ç¤ºä¾‹ã€‚åŠŸèƒ½åŒ…æ‹¬ï¼š

- å®Œæ•´ markdown-it æ”¯æŒï¼ˆè¡¨æ ¼ã€ä»»åŠ¡åˆ—è¡¨ã€è„šæ³¨ç­‰ï¼‰
- KaTeX è¡Œå†…ä¸å—çº§å…¬å¼
- highlight.js ä»£ç é«˜äº®ï¼ˆä»…å¯¹å¯è§ä»£ç é«˜äº®ï¼ŒèŠ‚çœèµ„æºï¼‰
- å›¾ç‰‡æ‹–æ‹½ / ç²˜è´´ / é€‰æ‹© â†’ è‡ªåŠ¨è½¬ base64
- æœ¬åœ°è‡ªåŠ¨ä¿å­˜ã€å¯¼å…¥/å¯¼å‡º
- ç§»åŠ¨ç«¯ï¼šç¼–è¾‘/é¢„è§ˆåˆ‡æ¢ã€è½¯é”®ç›˜ä¼˜åŒ–ã€è§¦æ§å‹å¥½æŒ‰é’®

## ç¤ºä¾‹ Mermaid

\`\`\`mermaid
graph TD
  A[å¼€å§‹] --> B{åˆ¤æ–­}
  B -->|æ˜¯| C[æ“ä½œ1]
  B -->|å¦| D[æ“ä½œ2]
\`\`\`

æ•°å­¦ç¤ºä¾‹ï¼š

è¡Œå†…ï¼š$\\frac{1}{x}$ï¼Œå—çº§ï¼š

$$
\\int_0^1 x^2 dx
$$
`;

/* ===============================
   åŠ è½½åˆå§‹æ–‡æœ¬
   =============================== */
try{
  editor.value = localStorage.getItem(STORAGE_KEY) || DEFAULT;
}catch(e){
  editor.value = DEFAULT;
}

/* ===============================
   ä¸»é¢˜ï¼ˆæ·±è‰²/æµ…è‰²ï¼‰
   =============================== */
function loadUserTheme(){
  try{ return localStorage.getItem(THEME_KEY) || 'auto'; }
  catch(e){ return 'auto'; }
}

// åº”ç”¨ä¸»é¢˜
function applyTheme(mode) {
  // åŠ ä¸ŠåŠ¨ç”» class
  document.body.classList.add('theme-transition');

  // ç”¨ä¸¤å±‚ requestAnimationFrame è®©æµè§ˆå™¨æ’ç‰ˆåå†æ‰§è¡Œä¸»é¢˜å˜åŒ–
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      if (mode === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
      } else if (mode === 'light') {
        document.documentElement.removeAttribute('data-theme');
      } else {
        // auto = è·Ÿéšç³»ç»Ÿ
        const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (sysDark) document.documentElement.setAttribute('data-theme', 'dark');
        else document.documentElement.removeAttribute('data-theme');
      }
    });
  });

  // å»¶è¿Ÿç§»é™¤åŠ¨ç”» classï¼ˆåŠ¨ç”»ç»“æŸï¼‰
  setTimeout(() => {
    document.body.classList.remove('theme-transition');
  }, 350); // è¦å’Œ CSS é‡Œçš„ transition æ—¶é—´åŒ¹é…

}
const opts = document.querySelectorAll('.theme-3way .opt');
const thumb = document.querySelector('.theme-3way .thumb');

const positions = {
  auto: '4px',
  light: 'calc(50% - 16px)',
  dark: 'calc(100% - 36px)'
};

function updateThemeUI(mode){
  // PC ä¸‰æ®µå¼€å…³
  opts.forEach(o => o.classList.remove('active'));
  const pcActive = document.querySelector(`.opt-${mode}`);
  if(pcActive) pcActive.classList.add('active');
  thumb.style.left = positions[mode];

  // æ‰‹æœºæŒ‰é’® UI æ›´æ–°
  const icons = { auto:"ğŸ–¥", light:"â˜€ï¸", dark:"ğŸŒ™" };
  themeMobileBtn.textContent = icons[mode];
}


function setTheme(mode){
  localStorage.setItem(THEME_KEY, mode);
  userTheme = mode;
  applyTheme(mode);
  updateThemeUI(mode);
}

/* PC */
opts.forEach(o => {
  o.addEventListener('click', () => {
    setTheme(o.dataset.value);
  });
});


/* æ‰‹æœºç«¯å•æŒ‰é’®ï¼šç‚¹å‡»è½®æ¢ Auto â†’ Light â†’ Dark */


function nextTheme(mode) {
  if (mode === "auto") return "light";
  if (mode === "light") return "dark";
  return "auto";
}

themeMobileBtn.addEventListener("click", () => {
  const newMode = nextTheme(userTheme);
  setTheme(newMode);

  // æ›´æ–°æŒ‰é’®å›¾æ ‡ï¼ˆğŸ–¥ â˜€ï¸ ğŸŒ™ï¼‰
  const icons = { auto: "ğŸ–¥", light: "â˜€ï¸", dark: "ğŸŒ™" };
  themeMobileBtn.textContent = icons[newMode];
});

// åˆå§‹åŒ–æŒ‰é’®å›¾æ ‡
const icons = { auto: "ğŸ–¥", light: "â˜€ï¸", dark: "ğŸŒ™" };
themeMobileBtn.textContent = icons[userTheme];

/* åˆå§‹åŒ– */

applyTheme(userTheme);
updateThemeUI(userTheme);

/* ç³»ç»Ÿåˆ‡æ¢ */
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=>{
  if(userTheme === 'auto') applyTheme('auto');
});

// è·Ÿéšç³»ç»Ÿï¼ˆå¦‚æœç”¨æˆ·é€‰æ‹© autoï¼‰
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
  if(userTheme === 'auto'){
    applyTheme('auto');
  }
});


/* ===============================
   å·¥å…·æ æ“ä½œï¼ˆæ’å…¥è¯­æ³•ï¼‰
   =============================== */
function wrapSelection(prefix, suffix = prefix){
  const el = editor;
  const start = el.selectionStart, end = el.selectionEnd;
  const sel = el.value.slice(start, end) || '';
  el.setRangeText(prefix + sel + suffix, start, end, 'end');
  el.focus();
  scheduleRender();
  scheduleSave();
}
document.querySelectorAll('[data-action]').forEach(btn=>{
  btn.addEventListener('click', e=>{
    const act = btn.getAttribute('data-action');
    if(act === 'bold') wrapSelection('**','**');
    else if(act === 'italic') wrapSelection('*','*');
    else if(act === 'h1') wrapSelection('\n# ','\n');
    else if(act === 'h2') wrapSelection('\n## ','\n');
    else if(act === 'code') wrapSelection('\n```\n','\n```\n');
    else if(act === 'ul') wrapSelection('\n- ','\n');
    else if(act === 'ol') wrapSelection('\n1. ','\n');
  });
});
document.getElementById('btnLink').addEventListener('click', ()=>{
  const url = prompt('è¾“å…¥é“¾æ¥ URLï¼š','https://');
  if(url) wrapSelection('[','](' + url + ')');
});

/* ===============================
   å›¾ç‰‡ï¼šé€‰æ‹© / æ‹–æ‹½ / ç²˜è´´ï¼ˆè½¬ base64ï¼‰
   =============================== */
document.getElementById('btnImage').addEventListener('click', ()=> document.getElementById('fileImage').click());
document.getElementById('fileImage').addEventListener('change', async e=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const data = await readFileAsDataURL(f);
  const pos = editor.selectionStart || editor.value.length;
  const mdImg = `![${f.name}](${data})\n`;
  editor.setRangeText(mdImg, pos, pos, 'end');
  scheduleRender(); scheduleSave();
});
editor.addEventListener('drop', async e=>{
  e.preventDefault();
  const files = Array.from(e.dataTransfer.files || []);
  for(const f of files){
    if(f.type.startsWith('image/')){
      const data = await readFileAsDataURL(f);
      const pos = editor.selectionStart || editor.value.length;
      editor.setRangeText(`![${f.name}](${data})\n`, pos, pos, 'end');
    } else if(f.name.endsWith('.md')){
      const text = await f.text(); editor.value = text; scheduleRender(); scheduleSave();
    }
  }
});
editor.addEventListener('paste', async e=>{
  const items = e.clipboardData && e.clipboardData.items;
  if(!items) return;
  for(const it of items){
    if(it.type && it.type.startsWith('image/')){
      const f = it.getAsFile();
      const data = await readFileAsDataURL(f);
      const pos = editor.selectionStart || editor.value.length;
      editor.setRangeText(`![pasted-image](${data})\n`, pos, pos, 'end');
      scheduleRender(); scheduleSave();
      e.preventDefault();
    }
  }
});
function readFileAsDataURL(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

/* ===============================
   å¯¼å…¥ / å¯¼å‡º
   =============================== */
document.getElementById('btnOpen').addEventListener('click', ()=> document.getElementById('fileOpen').click());
document.getElementById('fileOpen').addEventListener('change', async e=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const text = await f.text(); editor.value = text; scheduleRender(0); scheduleSave(0);
});
document.getElementById('btnSaveMd').addEventListener('click', ()=>{
  const blob = new Blob([editor.value], {type:'text/markdown;charset=utf-8'});
  const name = (prompt('æ–‡ä»¶åï¼ˆå¸¦ .mdï¼‰ï¼š','note.md')||'note.md').replace(/[\\\/:*?"<>|]/g,'_');
  saveBlob(blob, name);
});
document.getElementById('btnSaveHtml').addEventListener('click', ()=>{
  const html = renderToFullHtml(editor.value);
  saveBlob(new Blob([html], {type:'text/html;charset=utf-8'}), 'export.html');
});
function saveBlob(blob, name){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 600);
}
function renderToFullHtml(mdSrc){
  let html = md.render(mdSrc);
  html = renderMathInHtml(html);
  return `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="katex.min.css"><style>body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Microsoft Yahei";padding:24px}</style></head><body>${html}</body></html>`;
}

/* ===============================
   è‡ªåŠ¨ä¿å­˜ï¼ˆlocalStorageï¼‰
   =============================== */
let saveTimer = null;
function scheduleSave(delay=1000){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>{
    try{ localStorage.setItem(STORAGE_KEY, editor.value); status.textContent = new Date().toLocaleTimeString()+' å·²ä¿å­˜ï¼ˆæœ¬åœ°ï¼‰'; }catch(e){ status.textContent = 'ä¿å­˜å¤±è´¥'; }
    saveTimer = null;
  }, delay);
}

/* ===============================
   æ¸²æŸ“ï¼šmd -> html -> math -> mermaid -> highlight -> toc
   =============================== */
let renderTimer = null;
function scheduleRender(immediateDelay){
  if(renderTimer) clearTimeout(renderTimer);
  const delay = (immediateDelay !== undefined) ? immediateDelay : 150;
  renderTimer = setTimeout(()=>{ doRender(); renderTimer = null; }, delay);
}
function doRender(){
  let src = editor.value;
  // 1. md -> html
  let html = md.render(src);
  // 2. Math (KaTeX) -- replace $$...$$ and $...$
  html = renderMathInHtml(html);
  // 3. transform mermaid codeblocks to div.mermaid
  html = convertMermaidCodeblock(html);
  preview.innerHTML = html;
  // 4. highlight code blocks
  preview.querySelectorAll('pre code').forEach(block=>{
    try{ hljs.highlightBlock(block); }catch(e){}
  });
  // 5. init mermaid
  try{
    // mermaid init on elements with class 'language-mermaid' or div.mermaid
    const merElems = preview.querySelectorAll('.mermaid');
    merElems.forEach(node => {
      // mermaid can render from innerText
      // use mermaid.parse/render if available; mermaid.init will process .mermaid blocks
    });
    if(window.mermaid && typeof mermaid.init === 'function') mermaid.init(undefined, preview.querySelectorAll('.mermaid'));
  }catch(e){}
  // 6. build TOC
  buildTOC();
}

function renderMathInHtml(html){
  // block math $$...$$
  html = html.replace(/\$\$([\s\S]+?)\$\$/g, function(m,tex){
    try{
      const span = document.createElement('span');
      katex.render(tex, span, {displayMode:true, throwOnError:false});
      return span.outerHTML;
    }catch(e){ return `<pre>${escapeHtml(tex)}</pre>`; }
  });
  // inline $...$
  html = html.replace(/\$([^$]+?)\$/g, function(m,tex){
    try{
      const span = document.createElement('span');
      katex.render(tex, span, {displayMode:false, throwOnError:false});
      return span.outerHTML;
    }catch(e){ return `<code>${escapeHtml(tex)}</code>`; }
  });
  return html;
}

function convertMermaidCodeblock(html){
  // æ‰¾åˆ°è¢« markdown-it æ¸²æŸ“ä¸º <pre><code class="language-mermaid">...</code></pre>
  // æŠŠå®ƒæ›¿æ¢ä¸º <div class="mermaid">...</div>
  return html.replace(/<pre><code[^>]*class="[^"]*language-mermaid[^"]*"[^>]*>([\s\S]*?)<\/code><\/pre>/g, function(_, body){
    const text = body.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&');
    return `<div class="mermaid">${text}</div>`;
  });
}

function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ===============================
   TOC ç”Ÿæˆï¼ˆå¯æŠ˜å ï¼‰
   =============================== */
const tocContent = document.getElementById('tocContent');
const tocPanel = document.getElementById('tocPanel');
const tocCollapseBtn = document.getElementById('tocCollapseBtn');
let tocIsCollapsed = (localStorage.getItem(TOC_COLLAPSED) === '1');
function buildTOC(){
  const headers = preview.querySelectorAll('h1,h2,h3,h4,h5,h6');
  if(!headers.length){ tocContent.innerHTML = '<div class="note">ï¼ˆæ— æ ‡é¢˜ï¼‰</div>'; return; }
  const ul = document.createElement('ul');
  headers.forEach(h=>{
    const text = h.textContent;
    const id = text.trim().toLowerCase().replace(/[^\w]+/g,'-').replace(/^-|-$/g,'');
    h.id = id;
    const li = document.createElement('li');
    li.style.marginLeft = (parseInt(h.tagName.substring(1))-1)*8 + 'px';
    const a = document.createElement('a'); a.href = '#'+id; a.textContent = text;
    a.addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById(id).scrollIntoView({behavior:'smooth', block:'center'}); if(window.matchMedia && window.matchMedia('(max-width:1000px)').matches){ /* show preview */ document.getElementById('previewPanel').style.display='block'; document.getElementById('editorPanel').style.display='none'; } });
    li.appendChild(a); ul.appendChild(li);
  });
  tocContent.innerHTML = ''; tocContent.appendChild(ul);
  // apply collapse state
  if(tocIsCollapsed) { tocContent.style.display='none'; tocCollapseBtn.textContent='â–¸'; } else { tocContent.style.display='block'; tocCollapseBtn.textContent='â–¾'; }
}
tocCollapseBtn.addEventListener('click', ()=>{ tocIsCollapsed = !tocIsCollapsed; localStorage.setItem(TOC_COLLAPSED, tocIsCollapsed ? '1':'0'); buildTOC(); });

document.getElementById('btnToggleToc').addEventListener('click', ()=>{
  const cur = tocPanel.style.display === 'none' ? '' : 'none';
  tocPanel.style.display = cur;
});

/* ===============================
   äº‹ä»¶ï¼šå¿«æ·é”® / åŒæ­¥æ»šåŠ¨ / ç§»åŠ¨ç«¯åˆ‡æ¢
   =============================== */
document.addEventListener('keydown', e=>{
  const mod = e.ctrlKey || e.metaKey;
  if(mod && e.key.toLowerCase() === 'b'){ e.preventDefault(); wrapSelection('**','**'); }
  if(mod && e.key.toLowerCase() === 'i'){ e.preventDefault(); wrapSelection('*','*'); }
  if(mod && e.key.toLowerCase() === 's'){ e.preventDefault(); const blob=new Blob([editor.value], {type:'text/markdown;charset=utf-8'}); saveBlob(blob,'note.md'); }
});

editor.addEventListener('input', ()=>{
  scheduleRender();
  scheduleSave();
});
editor.addEventListener('scroll', ()=>{
  const ta = editor, pr = preview;
  const ratio = ta.scrollTop / (ta.scrollHeight - ta.clientHeight || 1);
  pr.scrollTop = ratio * (pr.scrollHeight - pr.clientHeight || 0);
});

/* ç§»åŠ¨ç«¯ ç¼–è¾‘/é¢„è§ˆ åˆ‡æ¢ */
document.getElementById('tabEdit').addEventListener('click', ()=>{
  document.getElementById('editorPanel').style.display='block';
  document.getElementById('previewPanel').style.display='none';
  document.getElementById('tabEdit').classList.add('active');
  document.getElementById('tabPreview').classList.remove('active');
});
document.getElementById('tabPreview').addEventListener('click', ()=>{
  document.getElementById('editorPanel').style.display='none';
  document.getElementById('previewPanel').style.display='block';
  document.getElementById('tabPreview').classList.add('active');
  document.getElementById('tabEdit').classList.remove('active');
});

/* ===============================
   åˆæ¬¡æ¸²æŸ“ä¸æ¢å¤
   =============================== */
scheduleRender(0);
try{
  if(localStorage.getItem(TOC_COLLAPSED) === '1') tocIsCollapsed = true;
}catch(e){}
buildTOC();
try{ localStorage.setItem('md-editor:last-open', new Date().toISOString()); }catch(e){}

/* ===============================
   å…¬å¼€/å·¥å…·å‡½æ•°
   =============================== */
function scheduleRenderNow(){ scheduleRender(0); }
window.__md_editor = { scheduleRender: scheduleRenderNow, editorElement: editor, previewElement: preview };

/* ===============================
   Helper: export render+math used when saving HTML
   =============================== */
function renderMathOnString(html){
  // used by renderToFullHtml
  return renderMathInHtml(html);
}
</script>
</body>
</html>
