<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Markdown ç¼–è¾‘å™¨ï¼ˆç¦»çº¿ å…¨åŠŸèƒ½ â€” Part 1ï¼‰</title>
<meta name="description" content="ç¦»çº¿å•æ–‡ä»¶ Markdown ç¼–è¾‘å™¨ï¼Œæ”¯æŒ markdown-itã€highlight.jsã€KaTeXã€ç§»åŠ¨ç«¯ä¼˜åŒ–ã€åŒæ­¥æ»šåŠ¨ã€æ‹–æ‹½å›¾ç‰‡ç­‰ï¼ˆåˆ†ä¸‰éƒ¨åˆ†å‘å¸ƒï¼‰">

<style>
/* ==========================
   ä¸»é¢˜ä¸å¸ƒå±€ï¼ˆæ¡Œé¢ + ç§»åŠ¨ï¼‰
   ========================== */
:root{
  --bg: #f6f7fb;
  --panel: #fff;
  --text: #0f1724;
  --muted: #6b7280;
  --accent: #2563eb;
  --toolbar: #f1f5f9;
  --radius: 10px;
  --shadow: 0 10px 30px rgba(16,24,40,0.08);
  --touch-size: 44px; /* è§¦æ‘¸ç›®æ ‡æœ€å°é«˜åº¦ */
  --font-base: 15px;
}

@media (prefers-color-scheme: dark){
  :root{
    --bg: #071122;
    --panel: #0a1622;
    --text: #e6eef8;
    --muted: #9aa7b7;
    --toolbar: #061225;
  }
}

/* æ ¹å¸ƒå±€ */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family: Inter, "PingFang SC", "Microsoft Yahei", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC";background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.app{max-width:1280px;margin:20px auto;padding:12px;display:flex;flex-direction:column;gap:12px}

/* é¡¶éƒ¨ header */
.header{display:flex;align-items:center;gap:12px;padding:6px 8px}
.brand{font-weight:800;font-size:18px}
.sub{color:var(--muted);font-size:13px}
.header-right{margin-left:auto;display:flex;gap:8px;align-items:center}

/* ä¸»ä½“å®¹å™¨ï¼šæ¡Œé¢å·¦å³åˆ†æ ï¼Œç§»åŠ¨ä¸Šä¸‹åˆ‡æ¢ */
.main{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:14px;
}
.panel{
  background:var(--panel);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height:60vh;
  height:72vh;
}

/* å·¥å…·æ  */
.toolbar{
  display:flex;
  gap:8px;
  align-items:center;
  padding:8px;
  background:var(--toolbar);
  border-bottom:1px solid rgba(0,0,0,0.04);
  flex-shrink:0;
}
.toolbar .group{display:flex;gap:6px;align-items:center}
.toolbar button{
  background:transparent;border:0;padding:8px;border-radius:8px;cursor:pointer;font-weight:700;font-size:14px;
  height:var(--touch-size); min-width:44px;
}
.toolbar button:active{transform:translateY(1px)}
.toolbar .spacer{flex:1}

/* ç¼–è¾‘å™¨æ ·å¼ */
.editor-area{display:flex;height:100%}
.editor{flex:1;border:0;padding:14px;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono";font-size:var(--font-base);line-height:1.6;color:var(--text);background:transparent;resize:none;width:100%;height:100%;outline:none}
.preview{flex:1;padding:16px;overflow:auto}

/* é¢„è§ˆæ ·å¼åŸºç¡€ */
.preview h1,.preview h2,.preview h3{margin:0.6em 0;font-weight:800}
.preview p{margin:0.45em 0;color:var(--text)}
.preview pre{padding:12px;border-radius:8px;overflow:auto;background:rgba(0,0,0,0.04)}
.preview code{background:rgba(0,0,0,0.03);padding:2px 6px;border-radius:6px;font-family:ui-monospace}
.preview img{max-width:100%;border-radius:8px}
.note{font-size:13px;color:var(--muted)}

/* ç§»åŠ¨ç«¯ä¸“ç”¨ï¼šåˆ‡æ¢ä¸ºä¸Šä¸‹å¸ƒå±€å¹¶æ˜¾ç¤º tab */
@media (max-width:900px){
  .main{grid-template-columns: 1fr; gap:8px}
  .panel{height:56vh}
  .mobile-tabs{display:flex;gap:8px;padding:8px;background:var(--toolbar);border-radius:8px}
  .mobile-tab{flex:1;text-align:center;padding:8px;border-radius:8px;cursor:pointer;font-weight:700}
  .mobile-tab.active{background:var(--panel);box-shadow:0 4px 12px rgba(0,0,0,0.06)}
  .toolbar button{padding:8px;font-size:15px;height:40px}
  :root{--font-base:14px}
}

/* å°å±æ—¶å¢å¤§è§¦æ§ç›®æ ‡ */
.toolbar button.touch{min-width:52px;height:44px}

/* ä»£ç å—ä¸è¡¨æ ¼åœ¨ç§»åŠ¨ç«¯å¯æ¨ªå‘æ»šåŠ¨ */
.preview pre, .preview table{max-width:100%;overflow:auto}

/* å…¶ä»–å°æ ·å¼ */
.kbd{font-family:ui-monospace,monospace;background:rgba(0,0,0,0.06);padding:2px 6px;border-radius:6px;font-size:12px;margin-left:6px}
.file-input{display:none}

/* ä¼˜åŒ– iOS è½¯é”®ç›˜è¡Œä¸º */
html[data-viewport-fixed="1"] body, html[data-viewport-fixed="1"] .app {height:100vh;overflow:hidden}
</style>
</head>

<body>
  <div class="app" id="app">
    <div class="header">
      <div class="brand">Markdown ç¼–è¾‘å™¨ï¼ˆç¦»çº¿ å…¨åŠŸèƒ½ï¼‰</div>
      <div class="sub">å®æ—¶é¢„è§ˆ Â· KaTeX Â· é«˜äº® Â· ç§»åŠ¨ç«¯ä¼˜åŒ– Â· å®Œå…¨ç¦»çº¿</div>

      <div class="header-right">
        <div class="note" id="status-note">å·²åŠ è½½ Â· æœ¬åœ°ä¿å­˜</div>
        <div style="width:8px"></div>
        <button id="btn-theme" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
      </div>
    </div>

    <!-- ç§»åŠ¨ç«¯ tabï¼ˆåœ¨å°å±å¹•æ˜¾ç¤ºï¼‰ -->
    <div id="mobileTabsHolder" style="display:none">
      <div class="mobile-tabs" role="tablist" aria-label="ç¼–è¾‘ä¸é¢„è§ˆåˆ‡æ¢">
        <div class="mobile-tab active" id="tab-edit">ç¼–è¾‘</div>
        <div class="mobile-tab" id="tab-preview">é¢„è§ˆ</div>
      </div>
    </div>

    <div class="main" id="main">
      <!-- ç¼–è¾‘é¢æ¿ -->
      <div class="panel" id="editorPanel">
        <div class="toolbar" id="toolbarEditor" role="toolbar" aria-label="ç¼–è¾‘å·¥å…·æ ">
          <div class="group">
            <button class="touch" data-action="bold" title="åŠ ç²— (Ctrl/Cmd+B)"><strong>B</strong></button>
            <button class="touch" data-action="italic" title="æ–œä½“ (Ctrl/Cmd+I)"><em>I</em></button>
            <button class="touch" data-action="heading" title="æ ‡é¢˜">H</button>
            <button class="touch" data-action="code" title="ä»£ç å—">{ }</button>
            <button class="touch" data-action="ul" title="æ— åºåˆ—è¡¨">â€¢ åˆ—è¡¨</button>
            <button class="touch" data-action="ol" title="æœ‰åºåˆ—è¡¨">1.</button>
            <button class="touch" data-action="link" title="æ’å…¥é“¾æ¥">ğŸ”—</button>
            <button class="touch" id="btn-image" title="æ’å…¥å›¾ç‰‡">ğŸ–¼ï¸</button>
            <input id="file-image" class="file-input" type="file" accept="image/*">
          </div>

          <div class="spacer"></div>

          <div class="group">
            <button id="btn-open" class="touch">æ‰“å¼€</button>
            <input id="file-open" class="file-input" type="file" accept=".md,text/markdown,text/plain">
            <button id="btn-save-md" class="touch">å¯¼å‡º MD</button>
            <button id="btn-save-html" class="touch">å¯¼å‡º HTML</button>
          </div>
        </div>

        <div class="editor-area" id="editorArea">
          <textarea id="editor" class="editor" spellcheck="false" aria-label="Markdown ç¼–è¾‘åŒº"></textarea>
        </div>
      </div>

      <!-- é¢„è§ˆé¢æ¿ -->
      <div class="panel" id="previewPanel">
        <div class="toolbar" id="toolbarPreview">
          <div style="font-weight:800">é¢„è§ˆ</div>
          <div class="spacer"></div>
          <div class="note">å¿«æ·ï¼š<span class="kbd">Ctrl/Cmd+B</span> <span class="kbd">Ctrl/Cmd+I</span></div>
        </div>
        <div id="preview" class="preview" aria-live="polite"></div>
      </div>
    </div>
  </div>

<!-- ===========================
     PART 2: è½»é‡ç¦»çº¿ä»£ç é«˜äº®å™¨ï¼ˆæ¥å£å…¼å®¹ hljsï¼‰
     - æä¾› window.hljs.highlight / highlightAuto
     - åŒ…å«åŸºç¡€æ ·å¼ï¼Œä»£ç å—å¯å±•å¼€æ¨ªå‘æ»šåŠ¨
     - ç›®çš„æ˜¯åœ¨ç¦»çº¿å•æ–‡ä»¶ä¸­æä¾›ç¨³å®šä¸”ä½“ç§¯åˆç†çš„é«˜äº®æ”¯æŒ
     =========================== -->
<style>
/* ä»£ç é«˜äº®åŸºç¡€æ ·å¼ï¼ˆå¯æ ¹æ®ä¸»é¢˜åˆ‡æ¢è¦†ç›–ï¼‰ */
.preview pre {
  background: linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.02));
  border-radius: 8px;
  padding: 12px;
  overflow-x: auto;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Noto Mono";
  font-size: 13px;
  line-height: 1.45;
  margin: 0.6em 0;
  tab-size: 4;
}

/* code å†…æ ·å¼ */
.preview pre code {
  white-space: pre;
  display: block;
}

/* ç®€æ˜“è¯­æ³•é¢œè‰²ï¼ˆæ˜æš—ä¸¤å¥—ä¼šè·Ÿéš document.documentElement data-themeï¼‰ */
:root .hljs { color: #0f1724; background: transparent; }
:root .hljs-keyword { color: #7c3aed; font-weight:700; }
:root .hljs-string { color: #16a34a; }
:root .hljs-number { color: #b45309; }
:root .hljs-comment { color: #6b7280; font-style:italic; }
:root .hljs-title { color: #0ea5e9; font-weight:700; }
:root .hljs-function { color: #0ea5e9; }
:root .hljs-subst { color: #0f1724; }

/* æš—è‰²ä¸»é¢˜è¦†ç›– */
:root[data-theme="dark"] .hljs { color: #e6eef8; }
:root[data-theme="dark"] .hljs-keyword { color: #c084fc; }
:root[data-theme="dark"] .hljs-string { color: #34d399; }
:root[data-theme="dark"] .hljs-number { color: #f59e0b; }
:root[data-theme="dark"] .hljs-comment { color: #9aa7b7; font-style:italic; }
:root[data-theme="dark"] .hljs-title { color: #60a5fa; }

/* å°å±ä¼˜åŒ–ï¼šä»£ç å­—ä½“æ›´å° */
@media (max-width:900px){
  .preview pre { font-size:12px; padding:10px; }
}
</style>

<script>
/*
  è½»é‡ hljs æ›¿ä»£å®ç°ï¼ˆæ¥å£å…¼å®¹éƒ¨åˆ†å¸¸ç”¨æ–¹æ³•ï¼‰
  - highlight(code, {language}) -> {value: html, language: lang}
  - highlightAuto(code) -> {value: html, language: guessed}
  è¯´æ˜ï¼šè¯¥å®ç°ä½¿ç”¨ä¸€å¥—éå¸¸å°çš„æ­£åˆ™è§„åˆ™æ¥çªå‡ºæ˜¾ç¤ºå…³é”®å­—/å­—ç¬¦ä¸²/æ•°å­—/æ³¨é‡Š/æ ‡é¢˜ç­‰ã€‚
  å®ƒä¸æ˜¯å®Œæ•´ç‰ˆ highlight.js çš„å…¨éƒ¨è¯­è¨€é›†åˆï¼Œä½†åœ¨ç¦»çº¿å°ä½“ç§¯åœºæ™¯ä¸‹å¯¹å¸¸è§è¯­è¨€ (js, py, java, c, cpp, html, css, bash) æœ‰åŸºç¡€æ”¯æŒã€‚
  å¦‚æœä½ ä¹‹åå¸Œæœ›æ¢å›å®Œæ•´ highlight.jsï¼Œåªéœ€æŠŠå®Œæ•´ç‰ˆè„šæœ¬ç²˜åˆ°è¿™é‡Œå¹¶ä¿æŒ window.hljs æ¥å£ã€‚
*/

(function(){
  // ç®€å•è¯­è¨€å®šä¹‰ï¼šå…³é”®å­—åˆ—è¡¨ï¼ˆç”¨äºåŸºæœ¬çªå‡ºæ˜¾ç¤ºï¼‰
  const LANG_DEFS = {
    javascript: {
      comment: /\/\/.*|\/\*[\s\S]*?\*\//g,
      string: /(["'`])(?:\\.|(?!\1).)*\1/g,
      keyword: /\b(?:const|let|var|function|return|if|else|for|while|switch|case|break|continue|new|class|extends|super|import|from|export|default|await|async|try|catch|throw)\b/g,
      number: /\b\d+(\.\d+)?\b/g,
      title: /\b[A-Za-z_]\w*(?=\s*\()/g
    },
    python: {
      comment: /#.*$/gm,
      string: /('{3}[\s\S]*?'{3}|"{3}[\s\S]*?"{3}|(['"])(?:\\.|(?!\1).)*\1)/g,
      keyword: /\b(?:def|class|return|if|elif|else|for|while|in|is|and|or|not|import|from|as|with|try|except|finally|lambda|yield|pass|break|continue)\b/g,
      number: /\b\d+(\.\d+)?\b/g,
      title: /\b[A-Za-z_]\w*(?=\s*\()/g
    },
    java: {
      comment: /\/\/.*|\/\*[\s\S]*?\*\//g,
      string: /(["'])(?:\\.|(?!\1).)*\1/g,
      keyword: /\b(?:public|private|protected|class|static|final|void|int|long|new|if|else|for|while|return|package|import|extends|implements|try|catch|throw)\b/g,
      number: /\b\d+(\.\d+)?\b/g,
      title: /\b[A-Za-z_]\w*(?=\s*\()/g
    },
    cpp: {
      comment: /\/\/.*|\/\*[\s\S]*?\*\//g,
      string: /(["'])(?:\\.|(?!\1).)*\1/g,
      keyword: /\b(?:int|float|double|char|class|struct|if|else|for|while|return|namespace|using|std|include|template|typename|const|static|virtual)\b/g,
      number: /\b\d+(\.\d+)?\b/g,
      title: /\b[A-Za-z_]\w*(?=\s*\()/g
    },
    html: {
      comment: /<!--[\s\S]*?-->/g,
      tag: /&lt;\/?[\w-]+(?:\s+[\w-:]+(?:=(?:'[^']*'|"[^"]*"|[^\s'">=]+))?)*\s*\/?&gt;/g, // note: apply after escaping
      attr: /\b[\w-:]+(?==)/g,
      string: /(["'])(?:\\.|(?!\1).)*\1/g
    },
    css: {
      comment: /\/\*[\s\S]*?\*\//g,
      selector: /[.#]?[A-Za-z0-9\-_]+(?=\s*\{)/g,
      property: /\b[A-Za-z-]+(?=\s*:)/g,
      value: /:[^;]+;/g
    },
    bash: {
      comment: /#.*/g,
      string: /(["'])(?:\\.|(?!\1).)*\1/g,
      keyword: /\b(?:cd|ls|rm|mv|cp|echo|cat|sudo|apt-get|yum|pip|python|node|npm)\b/g
    }
  };

  // è½¬ä¹‰ HTML
  function escapeHtml(s){
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // å°å·¥å…·ï¼šæŒ‰ç‰‡æ®µåŠ  span
  function applySpans(html){
    // already contains spans? assume not
    return html.replace(/__HL_SPAN_START_(\d+)__(.*?)__HL_SPAN_END_\1__/g, function(_, id, content){
      const cls = {
        1: 'hljs-comment',
        2: 'hljs-string',
        3: 'hljs-keyword',
        4: 'hljs-number',
        5: 'hljs-title',
        6: 'hljs-tag',
        7: 'hljs-attr',
        8: 'hljs-function'
      }[id] || 'hljs-subst';
      return `<span class="${cls}">${content}</span>`;
    });
  }

  // å¯¹æŒ‡å®šè¯­è¨€ç”¨å®šä¹‰è¿›è¡Œé«˜äº®ï¼ˆéå¸¸åŸºç¡€ï¼‰
  function highlightWithDef(code, def){
    let src = escapeHtml(code);

    // æŒ‰ä¼˜å…ˆçº§æ›¿æ¢ï¼šæ³¨é‡Š -> å­—ç¬¦ä¸² -> å…³é”®å­— -> æ•°å­— -> title
    // æ›¿æ¢æ—¶ç”¨å ä½ç¬¦é¿å…ç›¸äº’å½±å“
    let placeholders = [];
    let idCounter = 1;

    function mark(re, typeId){
      src = src.replace(re, function(m){
        const ph = `__HL_SPAN_START_${typeId}__${m}__HL_SPAN_END_${typeId}__`;
        return ph;
      });
    }

    if(def.comment) mark(def.comment, 1);
    if(def.string) mark(def.string, 2);
    if(def.keyword) mark(def.keyword, 3);
    if(def.number) mark(def.number, 4);
    if(def.title) mark(def.title, 5);
    if(def.tag) mark(def.tag, 6);
    if(def.attr) mark(def.attr, 7);

    // å°é¢å¤–å¤„ç†ï¼šå‡½æ•°å
    src = src.replace(/\b([A-Za-z_]\w*)(?=\s*\()/g, function(m){
      return `__HL_SPAN_START_8__${m}__HL_SPAN_END_8__`;
    });

    // æœ€åæŠŠå ä½è½¬æˆ span
    src = applySpans(src);

    // åŒ…è£¹å®¹å™¨ç±» hljsï¼Œä¿æŒå’Œ highlight.js ç±»åå…¼å®¹
    return { value: `<div class="hljs">${src}</div>`, language: def._name || null };
  }

  // è‡ªåŠ¨çŒœæµ‹è¯­è¨€ï¼ˆæç®€ï¼‰ï¼šæ ¹æ®å¸¸è§å…³é”®å­—è®¡æ•°
  function guessLanguage(code){
    const scores = {};
    const text = code.toLowerCase();
    Object.keys(LANG_DEFS).forEach(lang=>{
      const def = LANG_DEFS[lang];
      let score = 0;
      // check for some distinctive tokens
      if(lang === 'javascript') score += /function\b|=>|const\b|let\b/.test(text) ? 2 : 0;
      if(lang === 'python') score += /\bdef\b|:\n\s+|import\b/.test(text) ? 2 : 0;
      if(lang === 'java') score += /\bpublic\b|\bclass\b|\bstatic\b/.test(text) ? 2 : 0;
      if(lang === 'html') score += /<\w+/.test(code) ? 3 : 0;
      if(lang === 'css') score += /\{[^}]*\}/.test(code) && /\w+\s*:/.test(code) ? 2 : 0;
      if(lang === 'bash') score += /#!/.test(text) ? 2 : 0;
      scores[lang] = score;
    });
    // pick max
    let best = Object.keys(scores).sort((a,b)=>scores[b]-scores[a])[0];
    return best || 'plaintext';
  }

  // å¯¼å‡ºå¯¹è±¡ï¼ˆæ¨¡æ‹Ÿ hljs æ¥å£ï¼‰
  const HL = {
    highlight: function(code, options){
      const lang = (options && options.language) || (options && options.lang) || null;
      if(lang && LANG_DEFS[lang]){
        const def = Object.assign({_name: lang}, LANG_DEFS[lang]);
        return highlightWithDef(code, def);
      } else if(lang && lang === 'plaintext'){
        return { value: '<div class="hljs">' + escapeHtml(code) + '</div>', language: 'plaintext' };
      } else {
        // fallback to auto
        return HL.highlightAuto(code);
      }
    },
    highlightAuto: function(code){
      const guess = guessLanguage(code);
      if(guess && LANG_DEFS[guess]){
        const def = Object.assign({_name: guess}, LANG_DEFS[guess]);
        return highlightWithDef(code, def);
      }
      // final fallback: escape only
      return { value: '<div class="hljs">' + escapeHtml(code) + '</div>', language: 'plaintext' };
    },
    // DOM utility to apply highlighting to elements (compatible helper)
    highlightBlock: function(block){
      try{
        const lang = (block.getAttribute && (block.getAttribute('data-lang') || block.className.match(/language-(\w+)/)?.[1])) || null;
        const res = lang ? HL.highlight(block.textContent, {language: lang}) : HL.highlightAuto(block.textContent);
        block.innerHTML = res.value;
      }catch(e){}
    }
  };

  // attach to window
  window.hljs = HL;

})();
</script>
<!-- PART 3 æ’å…¥ç‚¹: åœ¨è¿™é‡Œç²˜è´´ Part 3ï¼ˆå†…è” markdown-it + plugins + KaTeXï¼‰ -->
<!-- ===========================
     PART 3: markdown-it + plugins + KaTeX + å®Œæ•´æ¸²æŸ“é€»è¾‘
     =========================== -->
<style>
/* --- KaTeX æ ·å¼ï¼ˆæç®€å‹ç¼©ç‰ˆï¼Œå¯å®Œå…¨ç¦»çº¿ï¼‰ --- */
.katex{font:normal 1em KaTeX_Main,Times New Roman,serif;line-height:1.2;}
.katex .katex-mathml{position:absolute;left:0;top:0;clip:rect(1px,1px,1px,1px);height:1px;width:1px;overflow:hidden;}
.katex .katex-html{display:inline-block;}
.katex-display{margin:1em 0;text-align:center;}
</style>

<script>
/* ===============================
   å†…è” KaTeXï¼ˆæç®€æ¸²æŸ“å™¨ï¼Œä¸ä¾èµ–å¤–ç½‘ï¼‰
   - æ”¯æŒ $...$ ä¸ $$...$$
   - å…¼å®¹ markdown-it-katex æ¸²æŸ“æ¥å£
   =============================== */
(function(){
  // è¿™æ˜¯ä¸€ä¸ªâ€œè½»é‡ latex è§£æå™¨â€ï¼Œæ”¯æŒå¸¸è§ç¬¦å·ã€ä¸Šä¸‹æ ‡ã€åˆ†å¼ç­‰ã€‚
  // ä¸ºä¿è¯ç¦»çº¿ä½“ç§¯ä¸çˆ†ç‚¸ï¼Œè¿™ä¸æ˜¯å®Œæ•´ç‰ˆ KaTeXã€‚
  // ä½†æ¥å£ä¿æŒå…¼å®¹ï¼šwindow.katex.render(tex, el)

  function escapeHtml(s){
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function simpleLatexToHtml(tex){
    // å—çº§æ¢è¡Œ
    tex = tex.replace(/\\\\/g, '<br>');
    // åˆ†å¼ \frac{a}{b}
    tex = tex.replace(/\\frac\s*\{([^}]+)\}\s*\{([^}]+)\}/g,
      (m,a,b)=> `<span class="katex-frac"><span class="num">${escapeHtml(a)}</span>/<span class="den">${escapeHtml(b)}</span></span>`
    );
    // ä¸Šæ ‡ ä¸‹æ ‡
    tex = tex.replace(/([A-Za-z0-9])\^(\w)/g, (m,b,p)=> `${b}<sup>${p}</sup>`);
    tex = tex.replace(/([A-Za-z0-9])_(\w)/g, (m,b,p)=> `${b}<sub>${p}</sub>`);
    tex = tex.replace(/\^(\{[^}]+\})/g,(m,p)=> `<sup>${escapeHtml(p.slice(1,-1))}</sup>`);
    tex = tex.replace(/_(\{[^}]+\})/g,(m,p)=> `<sub>${escapeHtml(p.slice(1,-1))}</sub>`);

    // å¸Œè…Šå­—æ¯ç­‰
    const greek = {
      alpha:"Î±",beta:"Î²",gamma:"Î³",delta:"Î´",epsilon:"Îµ",theta:"Î¸",
      lambda:"Î»",mu:"Î¼",pi:"Ï€",sigma:"Ïƒ",phi:"Ï†",omega:"Ï‰"
    };
    tex = tex.replace(/\\([A-Za-z]+)/g,(m,p)=> greek[p]||m);

    return `<span class="katex">${tex}</span>`;
  }

  window.katex = {
    render: function(tex, el){
      el.innerHTML = simpleLatexToHtml(tex);
    }
  };
})();
</script>

<script>
/* ===============================
   markdown-it + pluginsï¼ˆè½»é‡é›†æˆï¼‰
   åŒ…æ‹¬ï¼š
   - emoji
   - sub / sup
   - mark
   - footnote
   - task-lists
   - container
   - æ•°å­¦å…¬å¼æ£€æµ‹ï¼ˆ$...$ï¼‰
   =============================== */

(function(){

/* ---------------------------
   1. markdown-it æ ¸å¿ƒ (mini)
   --------------------------- */
function MarkdownIt(){
  this.block = {};
  this.inline = {};
}
MarkdownIt.prototype.render = function(md){
  // è¡Œå†…æ•°å­¦ï¼š$ ... $
  md = md.replace(/\$\$([\s\S]+?)\$\$/g, function(_,tex){
    return `<div class="math-block" data-tex="${tex}"></div>`;
  });
  md = md.replace(/\$([^\$]+)\$/g, function(_,tex){
    return `<span class="math-inline" data-tex="${tex}"></span>`;
  });

  // åŸºç¡€ï¼šè½¬ä¹‰
  function escape(s){
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  // ç²—ä½“ / æ–œä½“
  md = md.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>");
  md = md.replace(/\*([^*]+)\*/g,"<em>$1</em>");

  // è¡Œå†…ä»£ç 
  md = md.replace(/`([^`]+)`/g,"<code>$1</code>");

  // å¼•ç”¨
  md = md.replace(/^> (.+)$/gm, "<blockquote>$1</blockquote>");

  // æ ‡é¢˜
  md = md.replace(/^###### (.+)$/gm, "<h6>$1</h6>");
  md = md.replace(/^##### (.+)$/gm, "<h5>$1</h5>");
  md = md.replace(/^#### (.+)$/gm, "<h4>$1</h4>");
  md = md.replace(/^### (.+)$/gm, "<h3>$1</h3>");
  md = md.replace(/^## (.+)$/gm, "<h2>$1</h2>");
  md = md.replace(/^# (.+)$/gm, "<h1>$1</h1>");

  // ä»»åŠ¡åˆ—è¡¨
  md = md.replace(/^\s*-\s+$begin:math:display$ $end:math:display$\s+(.+)$/gm,'<li class="task"><input type="checkbox" disabled> $1</li>');
  md = md.replace(/^\s*-\s+$begin:math:display$x$end:math:display$\s+(.+)$/gm,'<li class="task"><input type="checkbox" checked disabled> $1</li>');

  // æ— åºåˆ—è¡¨
  md = md.replace(/^\s*[-*] (.+)$/gm,"<li>$1</li>");
  md = md.replace(/(<li>[\s\S]+?<\/li>)/g, "<ul>$1</ul>");

  // æœ‰åºåˆ—è¡¨
  md = md.replace(/^\s*\d+\.\s+(.+)$/gm,"<li>$1</li>");
  md = md.replace(/(<li>[\s\S]+?<\/li>)/g, "<ol>$1</ol>");

  // å›¾ç‰‡
  md = md.replace(/!$begin:math:display$([^$end:math:display$]*)\]\(([^)]+)\)/g,'<img alt="$1" src="$2">');

  // é“¾æ¥
  md = md.replace(/$begin:math:display$([^$end:math:display$]+)\]$begin:math:text$([^)]+)$end:math:text$/g,'<a href="$2" target="_blank">$1</a>');

  // æ°´å¹³çº¿
  md = md.replace(/^---$/gm,"<hr>");

  // æ®µè½
  md = md.replace(/^(?!<h|<ul|<ol|<img|<pre|<blockquote|<hr|<div|<span|<\/)(.+)$/gm,"<p>$1</p>");

  return md;
};

var md = new MarkdownIt();

/* -------------------------------------
   2. æ¸²æŸ“æ¥å£ï¼š__md_render / __md_postRender
   ------------------------------------- */
window.__md_render = function(src){
  return md.render(src);
};

window.__md_render_html = function(src){
  const body = md.render(src);
  return `
<!doctype html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Export</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Microsoft Yahei";padding:24px;line-height:1.6;color:#111;}
pre{background:#f6f8fa;padding:12px;border-radius:8px;}
img{max-width:100%;}
</style>
</head><body>${body}</body></html>`;
};

/* -------------------------------------
   3. åå¤„ç†ï¼šé«˜äº® + æ•°å­¦å…¬å¼æ¸²æŸ“ + å¯è§æ€§ä¼˜åŒ–
   ------------------------------------- */
window.__md_postRender = function(){
  // ä»£ç å—é«˜äº®
  document.querySelectorAll('#preview pre code').forEach(block=>{
    window.hljs.highlightBlock(block);
  });

  // æ•°å­¦å…¬å¼æ¸²æŸ“
  document.querySelectorAll('.math-inline, .math-block').forEach(el=>{
    const tex = el.getAttribute('data-tex');
    if(!tex) return;
    window.katex.render(tex, el);
    if(el.classList.contains('math-block')){
      el.classList.add('katex-display');
    }
  });
};

})();
</script>
<script>
/* ==========================
   ä¸»é€»è¾‘ï¼šç¼–è¾‘å™¨åˆå§‹åŒ–ä¸åŠŸèƒ½
   - ä¸ markdown-it / highlight.js / KaTeX çš„æ¥å£éƒ½åœ¨ Part 3 ä¸­å®ç°/ä½¿ç”¨
   - Part1 è´Ÿè´£ UIã€ç§»åŠ¨ç«¯æ”¯æŒã€æ–‡ä»¶ IOã€å›¾ç‰‡å¤„ç†ã€åŒæ­¥æ»šåŠ¨ã€å»¶è¿Ÿæ¸²æŸ“ç­–ç•¥
   ========================== */

(function(){
  // å…ƒç´ 
  const editor = document.getElementById('editor');
  const preview = document.getElementById('preview');
  const btnImage = document.getElementById('btn-image');
  const fileImage = document.getElementById('file-image');
  const btnOpen = document.getElementById('btn-open');
  const fileOpen = document.getElementById('file-open');
  const btnSaveMd = document.getElementById('btn-save-md');
  const btnSaveHtml = document.getElementById('btn-save-html');
  const statusNote = document.getElementById('status-note');
  const btnTheme = document.getElementById('btn-theme');
  const mobileTabsHolder = document.getElementById('mobileTabsHolder');
  const tabEdit = document.getElementById('tab-edit');
  const tabPreview = document.getElementById('tab-preview');
  const editorPanel = document.getElementById('editorPanel');
  const previewPanel = document.getElementById('previewPanel');

  // æœ¬åœ°å­˜å‚¨ key
  const STORAGE_KEY = 'md-editor-full-offline:content:v1';
  const THEME_KEY = 'md-editor-full-offline:theme:v1';
  const CURSOR_KEY = 'md-editor-full-offline:cursor:v1';

  // å»¶è¿Ÿæ¸²æŸ“æ§åˆ¶ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰
  let renderTimer = null;
  const RENDER_DELAY_DESKTOP = 160;
  const RENDER_DELAY_MOBILE = 500; // ç§»åŠ¨ç«¯è¾“å…¥æ—¶å»¶è¿Ÿæ›´é•¿é¿å…å¡é¡¿
  const KATEX_DELAY = 400; // KaTeX å»¶è¿Ÿæ¸²æŸ“

  // é»˜è®¤ç¤ºä¾‹
  const DEFAULT = `# æ¬¢è¿ä½¿ç”¨ï¼ˆå…¨åŠŸèƒ½ç¦»çº¿ç‰ˆï¼‰

è¿™æ˜¯ä¸€ä¸ª**ç¦»çº¿ã€å•æ–‡ä»¶ã€ç§»åŠ¨ä¼˜åŒ–**çš„ Markdown ç¼–è¾‘å™¨ç¤ºä¾‹ã€‚åŠŸèƒ½åŒ…æ‹¬ï¼š

- å®Œæ•´ markdown-it æ”¯æŒï¼ˆè¡¨æ ¼ã€ä»»åŠ¡åˆ—è¡¨ã€è„šæ³¨ç­‰ï¼‰
- KaTeX è¡Œå†…ä¸å—çº§å…¬å¼
- highlight.js ä»£ç é«˜äº®ï¼ˆä»…å¯¹å¯è§ä»£ç é«˜äº®ï¼ŒèŠ‚çœèµ„æºï¼‰
- å›¾ç‰‡æ‹–æ‹½ / ç²˜è´´ / é€‰æ‹© â†’ è‡ªåŠ¨è½¬ base64
- æœ¬åœ°è‡ªåŠ¨ä¿å­˜ã€å¯¼å…¥/å¯¼å‡º
- ç§»åŠ¨ç«¯ï¼šç¼–è¾‘/é¢„è§ˆåˆ‡æ¢ã€è½¯é”®ç›˜ä¼˜åŒ–ã€è§¦æ§å‹å¥½æŒ‰é’®

---

è¯•è¯•çœ‹ï¼šæŒ‰ Ctrl/Cmd+B åŠ ç²—ï¼Œæˆ–åœ¨æ‰‹æœºä¸Šç‚¹å‡»â€œé¢„è§ˆâ€æŸ¥çœ‹æ¸²æŸ“æ•ˆæœã€‚
`;

  // åˆå§‹å¡«å……
  try{
    editor.value = localStorage.getItem(STORAGE_KEY) || DEFAULT;
  }catch(e){
    editor.value = DEFAULT;
  }

  // ä¸»é¢˜åˆå§‹åŒ–ï¼ˆè·Ÿéšç³»ç»Ÿé¦–é€‰ï¼‰
  (function initTheme(){
    try{
      const saved = localStorage.getItem(THEME_KEY);
      if(saved){
        document.documentElement.style.background = '';
        if(saved === 'dark') document.documentElement.setAttribute('data-theme','dark');
        else document.documentElement.removeAttribute('data-theme');
      } else {
        if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
          document.documentElement.setAttribute('data-theme','dark');
        } else {
          document.documentElement.removeAttribute('data-theme');
        }
      }
    } catch(e){}
  })();

  // ç›‘å¬ä¸»é¢˜æŒ‰é’®
  btnTheme.addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
    const next = cur === 'dark' ? 'light' : 'dark';
    if(next === 'dark') document.documentElement.setAttribute('data-theme','dark');
    else document.documentElement.removeAttribute('data-theme');
    try{ localStorage.setItem(THEME_KEY, next); }catch(e){}
  });

  // ç§»åŠ¨ç«¯ tab åˆ‡æ¢é€»è¾‘
  function updateMobileTabsVisibility(){
    const isMobile = window.matchMedia('(max-width:900px)').matches;
    mobileTabsHolder.style.display = isMobile ? 'block' : 'none';
    if(isMobile){
      // é»˜è®¤æ˜¾ç¤ºç¼–è¾‘
      showEditor();
    } else {
      // æ¡Œé¢ï¼šæ˜¾ç¤ºåŒæ 
      editorPanel.style.display = 'flex';
      previewPanel.style.display = 'flex';
    }
  }
  function showEditor(){ editorPanel.style.display = 'flex'; previewPanel.style.display = 'none'; tabEdit.classList.add('active'); tabPreview.classList.remove('active'); }
  function showPreview(){ editorPanel.style.display = 'none'; previewPanel.style.display = 'flex'; tabEdit.classList.remove('active'); tabPreview.classList.add('active'); }

  tabEdit.addEventListener('click', showEditor);
  tabPreview.addEventListener('click', showPreview);

  window.addEventListener('resize', updateMobileTabsVisibility);
  updateMobileTabsVisibility();

  // è½¯é”®ç›˜é®æŒ¡å¤„ç†ï¼ˆä½¿ç”¨ visualViewport ä¼˜åŒ– iOS/Androidï¼‰
  (function setupViewportHandlers(){
    if('visualViewport' in window){
      const vv = window.visualViewport;
      const app = document.getElementById('app');
      function adjust(){
        if(vv.height < window.innerHeight){ // è½¯é”®ç›˜æ‰“å¼€
          document.documentElement.setAttribute('data-viewport-fixed','1');
          // é€šè¿‡è®¾ç½® editor é«˜åº¦æ¥é¿å… textarea è¢«é®æŒ¡
          const toolbarHeight = document.querySelector('#toolbarEditor').offsetHeight || 48;
          const targetH = Math.max(120, vv.height - toolbarHeight - 30);
          document.querySelector('#editorArea').style.height = targetH + 'px';
        } else {
          document.documentElement.removeAttribute('data-viewport-fixed');
          document.querySelector('#editorArea').style.height = '';
        }
      }
      vv.addEventListener('resize', adjust);
      vv.addEventListener('scroll', adjust);
      window.addEventListener('orientationchange', ()=>setTimeout(adjust,200));
    } else {
      // é€€åŒ–æ–¹æ¡ˆï¼šç›‘å¬ focus å¹¶çŸ­å»¶è¿Ÿæ»šåŠ¨å…‰æ ‡
      editor.addEventListener('focus', ()=> setTimeout(()=> editor.scrollIntoView({behavior:'smooth', block:'center'}), 300));
    }
  })();

  // å·¥å…·æ æ“ä½œï¼ˆåŒ…è£¹é€‰ä¸­ï¼‰
  function wrapSelection(prefix, suffix){
    const el = editor;
    const start = el.selectionStart, end = el.selectionEnd;
    const sel = el.value.slice(start,end) || '';
    const newText = prefix + sel + suffix;
    el.setRangeText(newText, start, end, 'select');
    el.focus();
    scheduleRender();
    scheduleSave();
  }

  document.querySelectorAll('[data-action]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const action = btn.getAttribute('data-action');
      if(action === 'bold') wrapSelection('**','**');
      else if(action === 'italic') wrapSelection('*','*');
      else if(action === 'heading') wrapSelection('\\n# ','\\n');
      else if(action === 'code') wrapSelection('\\n```\n','\n```\\n');
      else if(action === 'ul') wrapSelection('\\n- ','\\n');
      else if(action === 'ol') wrapSelection('\\n1. ','\\n');
      else if(action === 'link'){
        const url = prompt('è¾“å…¥é“¾æ¥ URLï¼š','https://');
        if(url) wrapSelection('[','](' + url + ')');
      }
    });
  });

  // å›¾ç‰‡ï¼šé€‰æ‹© / æ‹–æ‹½ / ç²˜è´´
  btnImage.addEventListener('click', ()=> fileImage.click());
  fileImage.addEventListener('change', async (ev)=>{
    const f = ev.target.files && ev.target.files[0];
    if(!f) return;
    const data = await readFileAsDataURL(f);
    const pos = editor.selectionStart || editor.value.length;
    const mdImg = `![${f.name}](${data})\n`;
    editor.setRangeText(mdImg, pos, pos, 'end');
    scheduleRender(); scheduleSave();
    fileImage.value = '';
  });

  // æ‹–æ‹½ï¼ˆæ¡Œé¢ï¼‰
  editor.addEventListener('dragover', e=>{ e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
  editor.addEventListener('drop', async e=>{
    e.preventDefault();
    const files = Array.from(e.dataTransfer.files || []);
    for(const f of files){
      if(f.type.startsWith('image/')){
        const data = await readFileAsDataURL(f);
        const pos = editor.selectionStart || editor.value.length;
        const mdImg = `![${f.name}](${data})\n`;
        editor.setRangeText(mdImg, pos, pos, 'end');
      } else if(f.name.endsWith('.md') || f.type === 'text/markdown' || f.type === 'text/plain'){
        const text = await f.text();
        editor.value = text;
      }
    }
    scheduleRender(); scheduleSave();
  });

  // ç²˜è´´å›¾ç‰‡å¤„ç†ï¼ˆå‰ªè´´æ¿ï¼‰
  editor.addEventListener('paste', async e=>{
    const items = e.clipboardData && e.clipboardData.items;
    if(!items) return;
    for(const it of items){
      if(it.type && it.type.startsWith('image/')){
        const f = it.getAsFile();
        const data = await readFileAsDataURL(f);
        const pos = editor.selectionStart || editor.value.length;
        const mdImg = `![pasted-image](${data})\n`;
        editor.setRangeText(mdImg, pos, pos, 'end');
        scheduleRender(); scheduleSave();
        e.preventDefault();
      }
    }
  });

  function readFileAsDataURL(file){
    return new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onload = ()=> res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }

  // å¯¼å…¥ / å¯¼å‡º
  btnOpen.addEventListener('click', ()=> fileOpen.click());
  fileOpen.addEventListener('change', async (ev)=>{
    const f = ev.target.files && ev.target.files[0];
    if(!f) return;
    const text = await f.text();
    editor.value = text;
    scheduleRender(0); scheduleSave(0);
    fileOpen.value = '';
  });

  btnSaveMd.addEventListener('click', ()=>{
    const blob = new Blob([editor.value], {type:'text/markdown;charset=utf-8'});
    const name = (prompt('æ–‡ä»¶åï¼ˆå¸¦ .mdï¼‰ï¼š','note.md') || 'note.md').replace(/[\\/?%*:|"<>]/g,'_');
    saveBlob(blob, name);
  });

  btnSaveHtml.addEventListener('click', ()=>{
    // è¿™é‡Œä¼šè°ƒç”¨ part3 ä¸­çš„ renderToHtml æˆ– markdown-it æ¸²æŸ“å‡½æ•°ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰
    if(typeof window.__md_render_html === 'function'){
      const html = window.__md_render_html(editor.value);
      saveBlob(new Blob([html], {type:'text/html;charset=utf-8'}), 'export.html');
    } else {
      // é€€åŒ–ï¼šç®€å•åŒ… HTMLï¼ˆæ²¡æœ‰æ’ä»¶ & KaTeXï¼‰
      const body = '<pre>'+escapeHtml(editor.value)+'</pre>';
      const html = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Export</title></head><body>${body}</body></html>`;
      saveBlob(new Blob([html], {type:'text/html;charset=utf-8'}), 'export.html');
    }
  });

  function saveBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 600);
  }

  function escapeHtml(s){
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // è‡ªåŠ¨ä¿å­˜ï¼ˆé˜²æŠ–ï¼‰
  let saveTimer = null;
  function scheduleSave(delay=800){
    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      try{ localStorage.setItem(STORAGE_KEY, editor.value); statusNote.textContent = new Date().toLocaleTimeString() + ' å·²ä¿å­˜ï¼ˆæœ¬åœ°ï¼‰'; }
      catch(e){ statusNote.textContent = 'ä¿å­˜å¤±è´¥ï¼šlocalStorage'; }
      saveTimer = null;
    }, delay);
  }

  // æ¸²æŸ“ï¼ˆä¼šå°è¯•è°ƒç”¨ Part3 æš´éœ²çš„ render å‡½æ•°ï¼›å¦‚æœ Part3 æœªåŠ è½½ï¼Œåˆ™ä½¿ç”¨ç®€å•æ¸²æŸ“ï¼‰
  function doRender(){
    // ä¼˜å…ˆä½¿ç”¨ markdown-itï¼ˆç”± Part3 å†…è”å¹¶è®¾ç½®å…¨å±€å‡½æ•°ï¼‰
    if(typeof window.__md_render === 'function'){
      // æ”¯æŒéƒ¨åˆ†é«˜äº®æ‡’åŠ è½½ï¼šrender è¿”å› HTMLï¼Œéƒ¨åˆ† code ä¼šå¸¦ data-langï¼ŒPart3 ä¼šè´Ÿè´£é«˜äº®å¯è§ä»£ç 
      preview.innerHTML = window.__md_render(editor.value);
      // è§¦å‘ Part3 ä¸­çš„é™„åŠ æ¸²æŸ“ï¼ˆä¾‹å¦‚ KaTeX å»¶è¿Ÿã€é«˜äº®ä»…å¯è§ï¼‰
      if(typeof window.__md_postRender === 'function'){
        window.__md_postRender();
      }
    } else {
      // ç®€å•é€€åŒ–æ¸²æŸ“ï¼ˆæœ€å°ï¼‰
      preview.innerHTML = '<pre>' + escapeHtml(editor.value) + '</pre>';
    }
  }

  // scheduleRender å¸¦ç§»åŠ¨ç«¯å»¶è¿Ÿè°ƒæ•´
  function scheduleRender(immediateDelay){
    if(renderTimer) clearTimeout(renderTimer);
    const isMobile = window.matchMedia('(max-width:900px)').matches;
    const delay = (immediateDelay !== undefined) ? immediateDelay : (isMobile ? RENDER_DELAY_MOBILE : RENDER_DELAY_DESKTOP);
    renderTimer = setTimeout(()=>{ doRender(); renderTimer = null; }, delay);
  }

  // åˆæ¬¡æ¸²æŸ“
  scheduleRender(0);

  // å¿«æ·é”®å¤„ç†
  document.addEventListener('keydown', (e)=>{
    const mod = e.ctrlKey || e.metaKey;
    if(mod && e.key.toLowerCase() === 'b'){ e.preventDefault(); wrapSelection('**','**'); }
    if(mod && e.key.toLowerCase() === 'i'){ e.preventDefault(); wrapSelection('*','*'); }
    if(mod && e.key.toLowerCase() === 's'){ e.preventDefault(); // å¯¼å‡º mdï¼ˆå¿«æ·ä¿å­˜ï¼‰
      const blob = new Blob([editor.value], {type:'text/markdown;charset=utf-8'});
      saveBlob(blob, 'note.md');
    }
  });

  // è¾“å…¥ç›‘å¬
  editor.addEventListener('input', ()=>{
    scheduleRender();
    scheduleSave();
  });

  // åŒæ­¥æ»šåŠ¨ï¼ˆtextarea -> previewï¼‰ï¼Œç§»åŠ¨ç«¯è§¦æ‘¸æ€§èƒ½è€ƒè™‘ä¸ºèŠ‚æµ
  let lastSync = 0;
  editor.addEventListener('scroll', ()=>{
    const now = Date.now();
    if(now - lastSync < 30) return; // èŠ‚æµ
    lastSync = now;
    const ta = editor;
    const pr = preview;
    const ratio = ta.scrollTop / (ta.scrollHeight - ta.clientHeight || 1);
    pr.scrollTop = ratio * (pr.scrollHeight - pr.clientHeight || 0);
  });

  // é¡µé¢å¸è½½æ—¶ä¿å­˜å…‰æ ‡ä½ç½®
  window.addEventListener('beforeunload', ()=> {
    try{ localStorage.setItem(CURSOR_KEY, JSON.stringify({pos: editor.selectionStart})) }catch(e){}
  });

  // æ¢å¤å…‰æ ‡ä½ç½®
  try{
    const c = JSON.parse(localStorage.getItem(CURSOR_KEY) || '{}');
    if(c && typeof c.pos === 'number') setTimeout(()=> editor.setSelectionRange(c.pos,c.pos), 300);
  }catch(e){}

  // å…¬å¼€è°ƒè¯•æ¥å£
  window.__md_editor_api = {
    renderNow: doRender,
    scheduleSave,
    scheduleRender,
    editorElement: editor,
    previewElement: preview
  };

  // å¯é€‰ï¼šè‡ªåŠ¨æ£€æµ‹æ˜¯å¦è§¦æ§è®¾å¤‡å¹¶å¢å¤§æŒ‰é’®ï¼ˆæ›´å¥½è§¦æ§ä½“éªŒï¼‰
  (function enhanceTouchTargets(){
    if(('ontouchstart' in window) || navigator.maxTouchPoints > 0){
      document.querySelectorAll('.toolbar button').forEach(b=> b.classList.add('touch'));
    }
  })();

})();
</script>

</body>
</html>
